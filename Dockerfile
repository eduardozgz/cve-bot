FROM rust:1.72-slim as base
RUN apt update
RUN apt install libpq-dev -y
RUN cargo install diesel_cli@2.1.0 --no-default-features --features postgres

FROM base as development
WORKDIR /app
COPY . .
RUN cargo install cargo-watch
CMD ["sh", "-c", "cargo watch -x run"]

FROM base as release-build
WORKDIR /app
COPY . .
RUN cargo build --release

FROM base
WORKDIR /app
COPY --from=release-build /app/migrations ./migrations
COPY --from=release-build /app/diesel.toml ./
COPY --from=release-build /app/target/release/cve_bot ./cve_bot
CMD ["/app/cve_bot"]
